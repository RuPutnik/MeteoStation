TMD-1.3 - Transfer meteo data - 1.3.

‚ протоколе TMD-1.3 существует три типа пакетов информации:
- пакет данных - используетсЯ длЯ передачи погодных данных от ведомых модулей к главному;
- командный (управлЯющий) пакет - используетсЯ длЯ управлениЯ ведомыми модулЯми с помощью главных (или запроса на получениЯ информации);
- сервисный пакет - используетсЯ длЯ передачи служебных данных (в т.ч. ответа на запросы) от ведомых модулей главному. 

„лина пакета данных - 3*(24+8) = 96 байт, пакет представлЯет 3 сегмента, 
каждый из которых имеет одинаковый заголовок и концевик (кроме Ьподпакета и контрольной суммы)
ЉонтрольнаЯ сумма считаетсЯ на каждый сегмент отдельно.
ќлементами массива ЯвлЯютсЯ числа типа float, по 8 единиц в каждом сегменте

Ћписание элементов массивов пакета данных:

‘егмент 0:
0: id получателЯ (1 - длЯ центрального блока, 2 - длЯ внешнего блока, 3 - длЯ внутреннего блока)
1: id источника (1 - длЯ центрального блока, 2 - длЯ внешнего блока, 3 - длЯ внутреннего блока)
2: тип пакета (1 - пакет данных, 2 - управлЯющий пакет, 3 - служебный пакет)
3: 1-ый элемент данных (длЯ блока 2 -температура, длЯ блока 3 -температура)
4: 2-ый элемент данных (длЯ блока 2 -влажность, длЯ блока 3 -влажность)
5: номер пакета (постоЯнно растет начинаЯ с 0)
6: номер сегмента в пакете (0, 1, 2)
7: контрольнаЯ сумма сегмента (сумма значений элементов 0-6)

‘егмент 1:
0: id получателЯ (1 - длЯ центрального блока, 2 - длЯ внешнего блока, 3 - длЯ внутреннего блока)
1: id источника (1 - длЯ центрального блока, 2 - длЯ внешнего блока, 3 - длЯ внутреннего блока)
2: тип пакета (1 - пакет данных, 2 - управлЯющий пакет, 3 - служебный пакет)
3: 3-ый элемент данных (длЯ блока 2 -наличие дождЯ, длЯ блока 3 -уровень углекислого газа)
4: 4-ый элемент данных (длЯ блока 2 -давление, длЯ блока 3 -уровень шума)
5: номер пакета (постоЯнно растет начинаЯ с 0)
6: номер сегмента в пакете (0, 1, 2)
7: контрольнаЯ сумма сегмента (сумма значений элементов 0-6)

‘егмент 2:
0: id получателЯ (1 - длЯ центрального блока, 2 - длЯ внешнего блока, 3 - длЯ внутреннего блока)
1: id источника (1 - длЯ центрального блока, 2 - длЯ внешнего блока, 3 - длЯ внутреннего блока)
2: тип пакета (1 - пакет данных, 2 - управлЯющий пакет, 3 - служебный пакет)
3: 5-ый элемент данных (длЯ блока 2 -уровень освещенности, длЯ блока 3 -не задано (=0))
4: 6-ый элемент данных (длЯ блока 2 -уровень “”, длЯ блока 3 -не задано (=0))
5: номер пакета (постоЯнно растет начинаЯ с 0)
6: номер сегмента в пакете (0, 1, 2)
7: контрольнаЯ сумма сегмента (сумма значений элементов 0-6)

Ћписание элементов массивов командного пакета:

0: id получателЯ (1 - длЯ центрального блока, 2 - длЯ внешнего блока, 3 - длЯ внутреннего блока)
1: id источника (1 - длЯ центрального блока, 2 - длЯ внешнего блока, 3 - длЯ внутреннего блока)
2: тип пакета (= 2)
3: код команды
4: параметр (при наличии)
5: номер пакета (постоЯнно растет начинаЯ с 0)
6: номер сегмента в пакете (всегда = -1)
7: контрольнаЯ сумма пакета (сумма значений элементов 0-6)

Љоманды главного модулЯ:
1 - перезапустить радиомодуль и все возможные через 5 секунд
2 - выключить радиомодуль
3 - изменить частоту отправки данные (параметр - новый интервал в миллисек)
4 - прекратить отправку данных от датчика (параметр - номер датчика 1-6)
5 - восстановить отправку данных от датчика (параметр - номер датчика 1-6)
6 - запросить карту активности датчиков (включен-выключен)
7 - запросить текущий интервал между выдачей данных
8 - запросить времЯ работы модулЯ (в миллисек)
9 - сигнал биениЯ сердца (проверка наличиЯ свЯзи; 
реакциЯ ведомого - отправить квитанцию и зажечь на 500 мсек светодиод; отсылаетсЯ раз в минуту)

Ћписание элементов массивов сервисного пакета:

0: id получателЯ (1 - длЯ центрального блока, 2 - длЯ внешнего блока, 3 - длЯ внутреннего блока)
1: id источника (1 - длЯ центрального блока, 2 - длЯ внешнего блока, 3 - длЯ внутреннего блока)
2: тип пакета (= 3)
3: код сообщениЯ
4: данные сообщениЯ
5: номер пакета (постоЯнно растет начинаЯ с 0)
6: номер сегмента в пакете (всегда = -1)
7: контрольнаЯ сумма пакета (сумма значений элементов 0-6)

‘лужебные сообщениЯ от ведомых модулей:
1 - модуль включен и все датчики успешно инициализированы
2 - квитанциЯ о получении команды от главного модулЯ (параметры - номер команды и параметры (при наличии))
3 - ошибка инициализации датчика (параметр - номер датчика) 
4 - отчет об активности датчиков (ответ на команду 6 от главного модулЯ) 
Ћтчет имеет вид: 1 или 0 на позиции каждого бита 4 (начинаЯ с 0) элемента в массиве, начинаЯ со старшего. 
ЋставшиесЯ 2 младших бита в байте заполнЯютсЯ нулЯми.
5 - информациЯ о текущем интервале между выдчей данных (ответ на команду 7 от главного модулЯ)
6 - информациЯ о времени работы модулЯ в миллисек (ответ на команду 8 от главного модулЯ)
7 - получена ошибочнаЯ или неизвестнаЯ команда

Џримечание:
‘лужебные и командные пакеты не сегментируютсЯ и в элемент под индексом 6 записываетсЯ -1.
„лина служебного и командного пакета - 32 байта
“правлЯющие (командные) пакеты могут отсылатьсЯ только от главного модулЯ ведомым
‘лужебные пакеты могут отсылатьсЯ только от ведомых к главному модулю
Ќомера пакетов исходЯщий и входЯщих относительно главного модулЯ имеют отдельные нумерации

ѓлавный модуль после отправки команды ждет квитанцию о получении и 
(длЯ некоторых команд) ответное сообщение с данными. …сли не приходит то или другое, команда посылаетсЯ заново
Ђлгоритм повторЯетсЯ, пока не завершитсЯ успехом. Џроверка полученной квитанции о том, что она относитсЯ к выданной команде
производитсЯ по содержанию элементов 0, 1, 4 массива
‚ыдача новой команды запрещена до успешнего завершениЯ текущей (получениЯ квитанции и\или ответного корректного служебного пакета)
Ќе существует команд, которые при повторной выдаче могут необратимо сказатьсЯ на логике работы модулЯ.
