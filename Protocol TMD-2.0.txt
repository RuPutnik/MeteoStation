TMD-2.0 - Transfer meteo data - 2.0.

В протоколе TMD-2.0 существует три типа пакетов информации:
- пакет данных - используется для передачи погодных данных от ведомых модулей к главному;
- командный (управляющий) пакет - используется для управления ведомыми модулями с помощью главных (или запроса на получения информации);
- сервисный пакет - используется для передачи служебных данных (в т.ч. ответа на запросы) от ведомых модулей главному.

Длина пакета данных - 32 байта, представленные в виде структуры, содержащей следующие поля:

1. Тип пакета (целое беззнаковое, 4 бита. Значения: 1 - пакет данных, 2 - управляющий пакет, 3 - служебный пакет)
2. Id модуля-получателя (целое беззнаковое, 4 бита. Значения: 0 - для центрального блока, 2 - для внешнего блока, 1 - для внутреннего блока)
3. Id модуля-отправителя (целое беззнаковое, 4 бита. Значения: 0 - для центрального блока, 2 - для внешнего блока, 1 - для внутреннего блока)
4. Номер пакета (целое беззнаковое, 20 бит)
5-10. Значения метеопараметров (дробное, 4 байта)
11. Контрольная сумма (целое беззнаковое, 4 байта)

Метеопараметры для внутреннего модуля (id = 1) записываются следующим образом:
1. Температура
2. Влажность
3. Уровень углекислого газа
4. Уровень шума
5. Не используется (=0)
6. Не используется (=0)

Метеопараметры для внешнего модуля (id = 2) записываются следующим образом:

1. Температура
2. Влажность
3. Наличие дождя
4. Давление
5. Уровень освещенности
6. Уровень УФ-излучения

Длина команданого пакета - 14 байт, представленные в виде структуры, содержащей следующие поля:

1. Тип пакета (целое беззнаковое, 4 бита. Значения: 1 - пакет данных, 2 - управляющий пакет, 3 - служебный пакет)
2. Id модуля-получателя (целое беззнаковое, 4 бита. Значения: 0 - для центрального блока, 2 - для внешнего блока, 1 - для внутреннего блока)
3. Id модуля-отправителя (целое беззнаковое, 4 бита. Значения: 0 - для центрального блока, 2 - для внешнего блока, 1 - для внутреннего блока)
4. Номер пакета (целое беззнаковое, 20 бит)
5: Код команды (целое беззнаковое, 16 бит)
6: Параметр (при наличии, иначе -1) (дробное, 4 байта)
7. Контрольная сумма (целое беззнаковое, 4 байта)

Команды главного модуля:
1 - перезапустить модуль
2 - включить/выключить передачу метеоданных с модуля
3 - изменить временной интервал отправки данных (параметр - новый интервал в миллисек)
4 - прекратить отправку данных от датчика (параметр - номер датчика 1-6) (Не реализовано)
5 - восстановить отправку данных от датчика (параметр - номер датчика 1-6) (Не реализовано)
6 - запросить карту активности датчиков (включен-выключен) (Не реализовано)
7 - запросить текущий интервал между выдачей данных (в миллисек)
8 - запросить время работы модуля (в миллисек)
9 - сигнал биения сердца (проверка наличия связи; реакция ведомого - зажечь на некоторое время светодиод)

Длина служебного пакета - 14 байт, представленные в виде структуры, содержащей следующие поля:

1. Тип пакета (целое беззнаковое, 4 бита. Значения: 1 - пакет данных, 2 - управляющий пакет, 3 - служебный пакет)
2. Id модуля-получателя (целое беззнаковое, 4 бита. Значения: 0 - для центрального блока, 2 - для внешнего блока, 1 - для внутреннего блока)
3. Id модуля-отправителя (целое беззнаковое, 4 бита. Значения: 0 - для центрального блока, 2 - для внешнего блока, 1 - для внутреннего блока)
4. Номер пакета (целое беззнаковое, 20 бит)
5: Код служебного сообщения (целое беззнаковое, 16 бит)
6: Параметр (при наличии, иначе -1) (дробное, 4 байта)
7. Контрольная сумма (целое беззнаковое, 4 байта)

Служебные сообщения от ведомых модулей:
1 - модуль включен и все датчики успешно инициализированы
2 - квитанция о получении команды от главного модуля (параметры - номер команды и параметры (при наличии))
3 - ошибка инициализации датчика (параметр - номер датчика) 
4 - информация о текущем интервале между выдчей данных (ответ на команду 7 от главного модуля)
5 - информация о времени работы модуля в миллисек (ответ на команду 8 от главного модуля)
6 - получена ошибочная или неизвестная команда

Примечание:
Управляющие (командные) пакеты могут отсылаться только от главного модуля ведомым
Служебные пакеты могут отсылаться только от ведомых к главному модулю
Номера пакетов исходящий и входящих относительно главного модуля имеют отдельные нумерации

Процесс обмена данными при отправке команд главным модулем:
Главный модуль после отправки команды ждет квитанцию о получении типа "Получена корректная команда" и 
(для некоторых команд) ответное сообщение с данными. Если не приходит то или другое, команда посылается заново
Алгоритм повторяется некоторое количество раз, пока не завершится успехом или попытки не будут исчерпаны. 
Проверка полученной квитанции о том, что она относится к выданной команде
производится по содержанию полей 1, 2, 3, 5 структуры служебного пакета
Выдача новой команды запрещена до завершения (успешного или не успешного) выполнения текущей (получения квитанции (и, для некоторых команд) ответного корректного служебного пакета с данными)
Если модуль с датчиками не распознал полученую команду, он посылает квитанцию типа "Получена неизвестная команда"
Не существует команд, которые при повторной выдаче могут необратимо сказаться на логике работы модуля.