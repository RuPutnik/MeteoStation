TMD-1.3 - Transfer meteo data - 1.3.

В протоколе TMD-1.3 существует три типа пакетов информации:
- пакет данных - используется для передачи погодных данных от ведомых модулей к главному;
- командный (управляющий) пакет - используется для управления ведомыми модулями с помощью главных (или запроса на получения информации);
- сервисный пакет - используется для передачи служебных данных (в т.ч. ответа на запросы) от ведомых модулей главному. 

Длина пакета данных - 3*(24+8) = 96 байт, пакет представляет 3 сегмента, 
каждый из которых имеет одинаковый заголовок и концевик (кроме №подпакета и контрольной суммы)
Контрольная сумма считается общая на пакет и дублируется в каждый сегмент.
Элементами массива являются числа типа float, по 8 единиц в каждом сегменте

Описание элементов массивов пакета данных:

Сегмент 0:
0: id получателя (1 - для центрального блока, 2 - для внешнего блока, 3 - для внутреннего блока)
1: id источника (1 - для центрального блока, 2 - для внешнего блока, 3 - для внутреннего блока)
2: тип пакета (1 - пакет данных, 2 - управляющий пакет, 3 - служебный пакет)
3: 1-ый элемент данных (для блока 2 -температура, для блока 3 -температура)
4: 2-ый элемент данных (для блока 2 -влажность, для блока 3 -влажность)
5: номер пакета (постоянно растет начиная с 0)
6: номер сегмента в пакете (0, 1, 2)
7: контрольная сумма сегмента (сумма значений элементов 0-6)

Сегмент 1:
0: id получателя (1 - для центрального блока, 2 - для внешнего блока, 3 - для внутреннего блока)
1: id источника (1 - для центрального блока, 2 - для внешнего блока, 3 - для внутреннего блока)
2: тип пакета (1 - пакет данных, 2 - управляющий пакет, 3 - служебный пакет)
3: 3-ый элемент данных (для блока 2 -наличие дождя, для блока 3 -уровень углекислого газа)
4: 4-ый элемент данных (для блока 2 -давление, для блока 3 -уровень шума)
5: номер пакета (постоянно растет начиная с 0)
6: номер сегмента в пакете (0, 1, 2)
7: контрольная сумма сегмента (сумма значений элементов 0-6)

Сегмент 2:
0: id получателя (1 - для центрального блока, 2 - для внешнего блока, 3 - для внутреннего блока)
1: id источника (1 - для центрального блока, 2 - для внешнего блока, 3 - для внутреннего блока)
2: тип пакета (1 - пакет данных, 2 - управляющий пакет, 3 - служебный пакет)
3: 5-ый элемент данных (для блока 2 -уровень освещенности, для блока 3 -не задано (=0))
4: 6-ый элемент данных (для блока 2 -уровень УФ, для блока 3 -не задано (=0))
5: номер пакета (постоянно растет начиная с 0)
6: номер сегмента в пакете (0, 1, 2)
7: контрольная сумма сегмента (сумма значений элементов 0-6)

Описание элементов массивов командного пакета:

0: id получателя (1 - для центрального блока, 2 - для внешнего блока, 3 - для внутреннего блока)
1: id источника (1 - для центрального блока, 2 - для внешнего блока, 3 - для внутреннего блока)
2: тип пакета (= 2)
3: код команды
4: параметр (при наличии)
5: номер пакета (постоянно растет начиная с 0)
6: номер сегмента в пакете (всегда = -1)
7: контрольная сумма пакета (сумма значений элементов 0-6)

Команды главного модуля:
1 - перезапустить радиомодуль и все возможные через 5 секунд
2 - выключить радиомодуль
3 - изменить частоту отправки данные (параметр - новый интервал в миллисек)
4 - прекратить отправку данных от датчика (параметр - номер датчика 1-6)
5 - восстановить отправку данных от датчика (параметр - номер датчика 1-6)
6 - запросить карту активности датчиков (включен-выключен)
7 - запросить текущий интервал между выдачей данных
8 - запросить время работы модуля (в миллисек)
9 - сигнал биения сердца (проверка наличия связи; 
реакция ведомого - отправить квитанцию и зажечь на 500 мсек светодиод; отсылается раз в минуту)

Описание элементов массивов сервисного пакета:

0: id получателя (1 - для центрального блока, 2 - для внешнего блока, 3 - для внутреннего блока)
1: id источника (1 - для центрального блока, 2 - для внешнего блока, 3 - для внутреннего блока)
2: тип пакета (= 3)
3: код сообщения
4: данные сообщения
5: номер пакета (постоянно растет начиная с 0)
6: номер сегмента в пакете (всегда = -1)
7: контрольная сумма пакета (сумма значений элементов 0-6)

Служебные сообщения от ведомых модулей:
1 - модуль включен и все датчики успешно инициализированы
2 - квитанция о получении команды от главного модуля (параметры - номер команды и параметры (при наличии))
3 - ошибка инициализации датчика (параметр - номер датчика) 
4 - отчет об активности датчиков (ответ на команду 6 от главного модуля) 
Отчет имеет вид: 1 или 0 на позиции каждого бита 4 (начиная с 0) элемента в массиве, начиная со старшего. 
Оставшиеся 2 младших бита в байте заполняются нулями.
5 - информация о текущем интервале между выдчей данных (ответ на команду 7 от главного модуля)
6 - информация о времени работы модуля в миллисек (ответ на команду 8 от главного модуля)
7 - получена ошибочная или неизвестная команда

Примечание:
Служебные и командные пакеты не сегментируются и в элемент под индексом 6 записывается -1.
Длина служебного и командного пакета - 32 байта
Управляющие (командные) пакеты могут отсылаться только от главного модуля ведомым
Служебные пакеты могут отсылаться только от ведомых к главному модулю
Номера пакетов исходящий и входящих относительно главного модуля имеют отдельные нумерации

Главный модуль после отправки команды ждет квитанцию о получении и 
(для некоторых команд) ответное сообщение с данными. Если не приходит то или другое, команда посылается заново
Алгоритм повторяется, пока не завершится успехом. Проверка полученной квитанции о том, что она относится к выданной команде
производится по содержанию элементов 0, 1, 4 массива
Выдача новой команды запрещена до успешнего завершения текущей (получения квитанции и\или ответного корректного служебного пакета)
Не существует команд, которые при повторной выдаче могут необратимо сказаться на логике работы модуля.
